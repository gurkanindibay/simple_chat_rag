<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RAG Chat â€” Info</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width:800px;margin:40px auto;color:#111 }
      pre { background:#f7f7f7; padding:12px; border:1px solid #eee }
      button { margin-top:8px }
    </style>
  </head>
  <body>
    <h1>Configuration & Embeddings</h1>
    <p>This page shows current provider config and lets you delete stored embeddings (PGVector table).</p>

    <h2>Providers</h2>
    <pre id="cfg">Loading...</pre>

    <h2>Ingested PDFs</h2>
    <div id="ingested">Loading...</div>

    <h2>Embeddings</h2>
    <div>
      <button id="delete">Delete all embeddings (truncate table)</button>
      <div id="deleteResult"></div>
    </div>

    <p><a href="/">Back to chat</a></p>

    <script>
      async function loadConfig() {
        try {
          const res = await fetch('/config');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const j = await res.json();
          document.getElementById('cfg').textContent = JSON.stringify(j, null, 2);
        } catch (e) {
          console.error('Error loading config:', e);
          document.getElementById('cfg').textContent = 'Error: ' + e.message;
        }
      }

      async function loadIngestedPdfs() {
        try {
          const res = await fetch('/ingestion-status');
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const j = await res.json();
          console.log('Ingestion status:', j);
          const list = j.ingested || [];
          if (list.length === 0) {
            document.getElementById('ingested').innerHTML = '<p><em>No PDFs ingested yet.</em></p>';
          } else {
            const html = '<ul>' + list.map(item => 
              `<li><strong>${item.filename}</strong><br/><small>${item.pdf_path}</small><br/><small>Ingested: ${new Date(item.timestamp).toLocaleString()}</small></li>`
            ).join('') + '</ul>';
            document.getElementById('ingested').innerHTML = html;
          }
        } catch (e) {
          console.error('Error loading ingestion status:', e);
          document.getElementById('ingested').innerHTML = '<p><em>Error loading ingestion status: ' + e.message + '</em></p>';
        }
      }

      async function deleteEmbeddings() {
        if (!confirm('Delete all embeddings? This cannot be undone.')) return;
        try {
          const res = await fetch('/embeddings/delete', { method: 'POST' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const j = await res.json();
          const msg = j.error ? 'Error: ' + j.error : 'Success: ' + JSON.stringify(j.result);
          document.getElementById('deleteResult').textContent = msg;
        } catch (e) {
          console.error('Error deleting embeddings:', e);
          document.getElementById('deleteResult').textContent = 'Error: ' + e.message;
        }
      }

      // Ensure DOM is ready before running
      function initPage() {
        const deleteBtn = document.getElementById('delete');
        if (deleteBtn) {
          deleteBtn.onclick = deleteEmbeddings;
          loadConfig();
          loadIngestedPdfs();
        } else {
          // Retry after short delay if elements not yet available
          console.log('Delete button not found, retrying...');
          setTimeout(initPage, 100);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPage);
      } else {
        // DOM already loaded, run immediately
        initPage();
      }
    </script>
  </body>
</html>
